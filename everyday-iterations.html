<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 3 Everyday iterations | Everyday-R: Practical R for Data Science</title>
  <meta name="description" content="<p>This is a minimal example of using the bookdown package to write a book.
The HTML output format for this example is bookdown::gitbook,
set in the _output.yml file.</p>" />
  <meta name="generator" content="bookdown 0.32.1 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 3 Everyday iterations | Everyday-R: Practical R for Data Science" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="<p>This is a minimal example of using the bookdown package to write a book.
The HTML output format for this example is bookdown::gitbook,
set in the _output.yml file.</p>" />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 3 Everyday iterations | Everyday-R: Practical R for Data Science" />
  
  <meta name="twitter:description" content="<p>This is a minimal example of using the bookdown package to write a book.
The HTML output format for this example is bookdown::gitbook,
set in the _output.yml file.</p>" />
  

<meta name="author" content="by Brian Jungmin Park" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="everyday-data-wrangling.html"/>
<link rel="next" href="interlude-i-a-brief-glimpse-into-data.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Everyday-R by snowoflondon</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#r-syntax-in-this-book"><i class="fa fa-check"></i><b>1.1</b> R syntax in this book</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#r-packages-commonly-used-in-this-book"><i class="fa fa-check"></i><b>1.2</b> R packages commonly used in this book</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#installing-r-packages"><i class="fa fa-check"></i><b>1.3</b> Installing R packages</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#code-availability"><i class="fa fa-check"></i><b>1.4</b> Code availability</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#website-hosting"><i class="fa fa-check"></i><b>1.5</b> Website hosting</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="everyday-data-wrangling.html"><a href="everyday-data-wrangling.html"><i class="fa fa-check"></i><b>2</b> Everyday data wrangling</a>
<ul>
<li class="chapter" data-level="2.1" data-path="everyday-data-wrangling.html"><a href="everyday-data-wrangling.html#renaming-column-headers"><i class="fa fa-check"></i><b>2.1</b> Renaming column headers</a></li>
<li class="chapter" data-level="2.2" data-path="everyday-data-wrangling.html"><a href="everyday-data-wrangling.html#grouped-operations"><i class="fa fa-check"></i><b>2.2</b> Grouped operations</a></li>
<li class="chapter" data-level="2.3" data-path="everyday-data-wrangling.html"><a href="everyday-data-wrangling.html#data-transformation"><i class="fa fa-check"></i><b>2.3</b> Data transformation</a></li>
<li class="chapter" data-level="2.4" data-path="everyday-data-wrangling.html"><a href="everyday-data-wrangling.html#joining-and-separating-character-columns"><i class="fa fa-check"></i><b>2.4</b> Joining and separating character columns</a></li>
<li class="chapter" data-level="2.5" data-path="everyday-data-wrangling.html"><a href="everyday-data-wrangling.html#filtering-rows"><i class="fa fa-check"></i><b>2.5</b> Filtering rows</a></li>
<li class="chapter" data-level="2.6" data-path="everyday-data-wrangling.html"><a href="everyday-data-wrangling.html#subsetting-columns-based-on-strings"><i class="fa fa-check"></i><b>2.6</b> Subsetting columns based on strings</a></li>
<li class="chapter" data-level="2.7" data-path="everyday-data-wrangling.html"><a href="everyday-data-wrangling.html#long-and-wide-data-formats"><i class="fa fa-check"></i><b>2.7</b> Long and wide data formats</a></li>
<li class="chapter" data-level="2.8" data-path="everyday-data-wrangling.html"><a href="everyday-data-wrangling.html#trimming-strings"><i class="fa fa-check"></i><b>2.8</b> Trimming strings</a></li>
<li class="chapter" data-level="2.9" data-path="everyday-data-wrangling.html"><a href="everyday-data-wrangling.html#iterating-over-list-of-dataframes"><i class="fa fa-check"></i><b>2.9</b> Iterating over list of dataframes</a></li>
<li class="chapter" data-level="2.10" data-path="everyday-data-wrangling.html"><a href="everyday-data-wrangling.html#rowwise-operations"><i class="fa fa-check"></i><b>2.10</b> Rowwise operations</a></li>
<li class="chapter" data-level="2.11" data-path="everyday-data-wrangling.html"><a href="everyday-data-wrangling.html#conditional-transformation"><i class="fa fa-check"></i><b>2.11</b> Conditional transformation</a></li>
<li class="chapter" data-level="2.12" data-path="everyday-data-wrangling.html"><a href="everyday-data-wrangling.html#missing-values"><i class="fa fa-check"></i><b>2.12</b> Missing values</a></li>
<li class="chapter" data-level="2.13" data-path="everyday-data-wrangling.html"><a href="everyday-data-wrangling.html#joining-dataframes"><i class="fa fa-check"></i><b>2.13</b> Joining dataframes</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="everyday-iterations.html"><a href="everyday-iterations.html"><i class="fa fa-check"></i><b>3</b> Everyday iterations</a>
<ul>
<li class="chapter" data-level="3.1" data-path="everyday-iterations.html"><a href="everyday-iterations.html#iterating-over-multiple-columns-using-apply-dplyr-and-purrr"><i class="fa fa-check"></i><b>3.1</b> Iterating over multiple columns using <code>apply()</code>, <code>dplyr</code>, and <code>purrr</code></a></li>
<li class="chapter" data-level="3.2" data-path="everyday-iterations.html"><a href="everyday-iterations.html#iterating-over-lists"><i class="fa fa-check"></i><b>3.2</b> Iterating over lists</a></li>
<li class="chapter" data-level="3.3" data-path="everyday-iterations.html"><a href="everyday-iterations.html#iterating-over-vectors"><i class="fa fa-check"></i><b>3.3</b> Iterating over vectors</a></li>
<li class="chapter" data-level="3.4" data-path="everyday-iterations.html"><a href="everyday-iterations.html#iterating-with-two-inputs"><i class="fa fa-check"></i><b>3.4</b> Iterating with two inputs</a></li>
<li class="chapter" data-level="3.5" data-path="everyday-iterations.html"><a href="everyday-iterations.html#iterating-over-indices-and-names"><i class="fa fa-check"></i><b>3.5</b> Iterating over indices and names</a></li>
<li class="chapter" data-level="3.6" data-path="everyday-iterations.html"><a href="everyday-iterations.html#handling-errors-within-purrr"><i class="fa fa-check"></i><b>3.6</b> Handling errors within <code>purrr</code></a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="interlude-i-a-brief-glimpse-into-data.html"><a href="interlude-i-a-brief-glimpse-into-data.html"><i class="fa fa-check"></i><b>4</b> Interlude I: A brief glimpse into <code>data.table</code></a>
<ul>
<li class="chapter" data-level="4.1" data-path="interlude-i-a-brief-glimpse-into-data.html"><a href="interlude-i-a-brief-glimpse-into-data.html#data-wrangling-operations"><i class="fa fa-check"></i><b>4.1</b> Data wrangling operations</a></li>
<li class="chapter" data-level="4.2" data-path="interlude-i-a-brief-glimpse-into-data.html"><a href="interlude-i-a-brief-glimpse-into-data.html#sd-.sdcols-and"><i class="fa fa-check"></i><b>4.2</b> <code>.SD</code>, <code>.SDcols</code>, and <code>:=</code></a></li>
<li class="chapter" data-level="4.3" data-path="interlude-i-a-brief-glimpse-into-data.html"><a href="interlude-i-a-brief-glimpse-into-data.html#reshaping-data-using-melt-and-dcast"><i class="fa fa-check"></i><b>4.3</b> Reshaping data using <code>melt</code> and <code>dcast</code></a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="everyday-exploratory-data-analysis.html"><a href="everyday-exploratory-data-analysis.html"><i class="fa fa-check"></i><b>5</b> Everyday exploratory data analysis</a>
<ul>
<li class="chapter" data-level="5.1" data-path="everyday-exploratory-data-analysis.html"><a href="everyday-exploratory-data-analysis.html#workflow-1-continuous-data"><i class="fa fa-check"></i><b>5.1</b> Workflow 1: continuous data</a></li>
<li class="chapter" data-level="5.2" data-path="everyday-exploratory-data-analysis.html"><a href="everyday-exploratory-data-analysis.html#workflow-2-dates-and-ordinal-data"><i class="fa fa-check"></i><b>5.2</b> Workflow 2: dates and ordinal data</a></li>
<li class="chapter" data-level="5.3" data-path="everyday-exploratory-data-analysis.html"><a href="everyday-exploratory-data-analysis.html#visualization-of-clusters"><i class="fa fa-check"></i><b>5.3</b> Visualization of clusters</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="everyday-ml-classification.html"><a href="everyday-ml-classification.html"><i class="fa fa-check"></i><b>6</b> Everyday ML: Classification</a>
<ul>
<li class="chapter" data-level="6.1" data-path="everyday-ml-classification.html"><a href="everyday-ml-classification.html#model-training-and-predictions"><i class="fa fa-check"></i><b>6.1</b> Model training and predictions</a></li>
<li class="chapter" data-level="6.2" data-path="everyday-ml-classification.html"><a href="everyday-ml-classification.html#feature-selection-using-univariate-filters"><i class="fa fa-check"></i><b>6.2</b> Feature selection using univariate filters</a></li>
<li class="chapter" data-level="6.3" data-path="everyday-ml-classification.html"><a href="everyday-ml-classification.html#feature-selection-using-recursive-feature-elimination"><i class="fa fa-check"></i><b>6.3</b> Feature selection using recursive feature elimination</a></li>
<li class="chapter" data-level="6.4" data-path="everyday-ml-classification.html"><a href="everyday-ml-classification.html#hyperparameter-tuning"><i class="fa fa-check"></i><b>6.4</b> Hyperparameter tuning</a></li>
<li class="chapter" data-level="6.5" data-path="everyday-ml-classification.html"><a href="everyday-ml-classification.html#roc-and-precision-recall-curves"><i class="fa fa-check"></i><b>6.5</b> ROC and precision-recall curves</a></li>
<li class="chapter" data-level="6.6" data-path="everyday-ml-classification.html"><a href="everyday-ml-classification.html#model-comparisons"><i class="fa fa-check"></i><b>6.6</b> Model comparisons</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Everyday-R: Practical R for Data Science</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="everyday-iterations" class="section level1 hasAnchor" number="3">
<h1><span class="header-section-number">Chapter 3</span> Everyday iterations<a href="everyday-iterations.html#everyday-iterations" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>In the previous chapter, I briefly covered writing an iterative function using <code>purrr::map()</code>. In a practical setting, iterations are most useful when we’ve split our data based on some sort of a variable of interest. For example, say we have a dataset containing patient outcome after a treatment with a novel therapeutic. We could split the data based on the type of the therapeutic and iterate a model to compare and contrast treatment effects. On the other hand, we could simply want to apply some sort of a function over multiple columns of a dataset to save the trouble of writing the same function over and over.</p>
<p>A traditional iterative function involves explicitly writing a <code>for loop</code>. Though <code>for loops</code> are often misconstrued as being slower than the functional counterparts (e.g., the <code>apply()</code> family of base R functions), the real down-side of <code>for loops</code>, as Hadley argues in <a href="https://adv-r.hadley.nz/functionals.html">his book, ‘Advanced R’</a>, is that <code>for loops</code> do a poor job in conveying what should be done with the results.</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb124-1"><a href="everyday-iterations.html#cb124-1" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code></pre></div>
<div id="iterating-over-multiple-columns-using-apply-dplyr-and-purrr" class="section level2 hasAnchor" number="3.1">
<h2><span class="header-section-number">3.1</span> Iterating over multiple columns using <code>apply()</code>, <code>dplyr</code>, and <code>purrr</code><a href="everyday-iterations.html#iterating-over-multiple-columns-using-apply-dplyr-and-purrr" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Returning to the familiar dataset <code>mtcars</code>, composed of 32 rows and 12 columns:</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="everyday-iterations.html#cb125-1" tabindex="-1"></a><span class="fu">data</span>(mtcars)</span>
<span id="cb125-2"><a href="everyday-iterations.html#cb125-2" tabindex="-1"></a>mtcars <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(mtcars, <span class="at">rownames =</span> <span class="st">&#39;CAR&#39;</span>)</span></code></pre></div>
<p>The basic <code>apply()</code> function needs to know whether you’re iterating over columns or over rows using the <code>MARGIN =</code> argument:</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb126-1"><a href="everyday-iterations.html#cb126-1" tabindex="-1"></a><span class="fu">apply</span>(mtcars[<span class="sc">-</span><span class="dv">1</span>], <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="cf">function</span>(x) x<span class="sc">/</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span></code></pre></div>
<pre><code>##        mpg cyl  disp   hp  drat     wt   qsec  vs
## [1,] 10.50   3  80.0 55.0 1.950 1.3100  8.230 0.0
## [2,] 10.50   3  80.0 55.0 1.950 1.4375  8.510 0.0
## [3,] 11.40   2  54.0 46.5 1.925 1.1600  9.305 0.5
## [4,] 10.70   3 129.0 55.0 1.540 1.6075  9.720 0.5
## [5,]  9.35   4 180.0 87.5 1.575 1.7200  8.510 0.0
## [6,]  9.05   3 112.5 52.5 1.380 1.7300 10.110 0.5
##       am gear carb
## [1,] 0.5  2.0  2.0
## [2,] 0.5  2.0  2.0
## [3,] 0.5  2.0  0.5
## [4,] 0.0  1.5  0.5
## [5,] 0.0  1.5  1.0
## [6,] 0.0  1.5  0.5</code></pre>
<p>This returns a matrix, as <code>apply()</code> is typically used for an array or a matrix. The one downside with <code>apply()</code> is that the user cannot define what form the output will be in. The side effect of this is that I’ve had to exclude the first column because it contains characters. Running <code>cbind()</code> afterwards to concatenate <code>mtcars[1,]</code> can do the job, though it’s cumbersome. Therefore, it’s often not advisable to run <code>apply()</code> on a dataframe or a tibble. A better method is the <code>dplyr::mutate()</code> solution:</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb128-1"><a href="everyday-iterations.html#cb128-1" tabindex="-1"></a>mtcars <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span> .x<span class="sc">/</span><span class="dv">2</span>))</span></code></pre></div>
<pre><code>## # A tibble: 32 × 12
##    CAR      mpg   cyl  disp    hp  drat    wt  qsec
##    &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 Mazda… 10.5      3  80    55    1.95  1.31  8.23
##  2 Mazda… 10.5      3  80    55    1.95  1.44  8.51
##  3 Datsu… 11.4      2  54    46.5  1.92  1.16  9.30
##  4 Horne… 10.7      3 129    55    1.54  1.61  9.72
##  5 Horne…  9.35     4 180    87.5  1.58  1.72  8.51
##  6 Valia…  9.05     3 112.   52.5  1.38  1.73 10.1 
##  7 Duste…  7.15     4 180   122.   1.60  1.78  7.92
##  8 Merc … 12.2      2  73.4  31    1.84  1.60 10   
##  9 Merc … 11.4      2  70.4  47.5  1.96  1.58 11.4 
## 10 Merc …  9.6      3  83.8  61.5  1.96  1.72  9.15
## # ℹ 22 more rows
## # ℹ 4 more variables: vs &lt;dbl&gt;, am &lt;dbl&gt;,
## #   gear &lt;dbl&gt;, carb &lt;dbl&gt;</code></pre>
<p>Note that instead of writing out <code>function(x) x/2</code> I’m using the <code>~ .x</code> notation which is often used in context of <code>purrr:map()</code>. Either works.</p>
<p>The <code>purrr:map()</code> solution to this is:</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="everyday-iterations.html#cb130-1" tabindex="-1"></a>mtcars <span class="sc">%&gt;%</span> <span class="fu">map_if</span>(is.numeric, <span class="sc">~</span> .x<span class="sc">/</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>()</span></code></pre></div>
<pre><code>## # A tibble: 32 × 12
##    CAR      mpg   cyl  disp    hp  drat    wt  qsec
##    &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 Mazda… 10.5      3  80    55    1.95  1.31  8.23
##  2 Mazda… 10.5      3  80    55    1.95  1.44  8.51
##  3 Datsu… 11.4      2  54    46.5  1.92  1.16  9.30
##  4 Horne… 10.7      3 129    55    1.54  1.61  9.72
##  5 Horne…  9.35     4 180    87.5  1.58  1.72  8.51
##  6 Valia…  9.05     3 112.   52.5  1.38  1.73 10.1 
##  7 Duste…  7.15     4 180   122.   1.60  1.78  7.92
##  8 Merc … 12.2      2  73.4  31    1.84  1.60 10   
##  9 Merc … 11.4      2  70.4  47.5  1.96  1.58 11.4 
## 10 Merc …  9.6      3  83.8  61.5  1.96  1.72  9.15
## # ℹ 22 more rows
## # ℹ 4 more variables: vs &lt;dbl&gt;, am &lt;dbl&gt;,
## #   gear &lt;dbl&gt;, carb &lt;dbl&gt;</code></pre>
<p>Writing a for loop for something like this would have been less elegant:</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="everyday-iterations.html#cb132-1" tabindex="-1"></a>mtcars2 <span class="ot">&lt;-</span> mtcars</span>
<span id="cb132-2"><a href="everyday-iterations.html#cb132-2" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">ncol</span>(mtcars2)){</span>
<span id="cb132-3"><a href="everyday-iterations.html#cb132-3" tabindex="-1"></a>  mtcars2[,i] <span class="ot">&lt;-</span> mtcars2[,i]<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb132-4"><a href="everyday-iterations.html#cb132-4" tabindex="-1"></a>}</span>
<span id="cb132-5"><a href="everyday-iterations.html#cb132-5" tabindex="-1"></a>mtcars2</span></code></pre></div>
<pre><code>## # A tibble: 32 × 12
##    CAR      mpg   cyl  disp    hp  drat    wt  qsec
##    &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 Mazda… 10.5      3  80    55    1.95  1.31  8.23
##  2 Mazda… 10.5      3  80    55    1.95  1.44  8.51
##  3 Datsu… 11.4      2  54    46.5  1.92  1.16  9.30
##  4 Horne… 10.7      3 129    55    1.54  1.61  9.72
##  5 Horne…  9.35     4 180    87.5  1.58  1.72  8.51
##  6 Valia…  9.05     3 112.   52.5  1.38  1.73 10.1 
##  7 Duste…  7.15     4 180   122.   1.60  1.78  7.92
##  8 Merc … 12.2      2  73.4  31    1.84  1.60 10   
##  9 Merc … 11.4      2  70.4  47.5  1.96  1.58 11.4 
## 10 Merc …  9.6      3  83.8  61.5  1.96  1.72  9.15
## # ℹ 22 more rows
## # ℹ 4 more variables: vs &lt;dbl&gt;, am &lt;dbl&gt;,
## #   gear &lt;dbl&gt;, carb &lt;dbl&gt;</code></pre>
</div>
<div id="iterating-over-lists" class="section level2 hasAnchor" number="3.2">
<h2><span class="header-section-number">3.2</span> Iterating over lists<a href="everyday-iterations.html#iterating-over-lists" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The usefulness of iteration is more apparent when we’re working with grouped data. I’ve covered a bit of this in the previous chapter, but this is when we’ve split the data based on some sort of a categorical or a grouping variable.</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="everyday-iterations.html#cb134-1" tabindex="-1"></a>mtcars_lst <span class="ot">&lt;-</span> mtcars <span class="sc">%&gt;%</span> <span class="fu">group_split</span>(cyl)</span></code></pre></div>
<p>The member of the <code>apply()</code> family suited for this task is <code>lapply()</code> which returns a list:</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="everyday-iterations.html#cb135-1" tabindex="-1"></a><span class="fu">lapply</span>(mtcars_lst, <span class="cf">function</span>(x) <span class="fu">cor</span>(x<span class="sc">$</span>mpg, x<span class="sc">$</span>wt))</span></code></pre></div>
<pre><code>## [[1]]
## [1] -0.7131848
## 
## [[2]]
## [1] -0.6815498
## 
## [[3]]
## [1] -0.650358</code></pre>
<p>Of course, we can define our own function and then pass it over to <code>lapply()</code> instead:</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="everyday-iterations.html#cb137-1" tabindex="-1"></a>get_pval <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb137-2"><a href="everyday-iterations.html#cb137-2" tabindex="-1"></a>  mod <span class="ot">&lt;-</span> <span class="fu">cor.test</span>(x<span class="sc">$</span>mpg, x<span class="sc">$</span>wt)</span>
<span id="cb137-3"><a href="everyday-iterations.html#cb137-3" tabindex="-1"></a>  pv <span class="ot">&lt;-</span> mod<span class="sc">$</span>p.value</span>
<span id="cb137-4"><a href="everyday-iterations.html#cb137-4" tabindex="-1"></a>  <span class="cf">if</span> (pv <span class="sc">&lt;</span> <span class="fl">0.05</span>){</span>
<span id="cb137-5"><a href="everyday-iterations.html#cb137-5" tabindex="-1"></a>    is_sig <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb137-6"><a href="everyday-iterations.html#cb137-6" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb137-7"><a href="everyday-iterations.html#cb137-7" tabindex="-1"></a>    is_sig <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb137-8"><a href="everyday-iterations.html#cb137-8" tabindex="-1"></a>  }</span>
<span id="cb137-9"><a href="everyday-iterations.html#cb137-9" tabindex="-1"></a>  <span class="fu">return</span>(is_sig)</span>
<span id="cb137-10"><a href="everyday-iterations.html#cb137-10" tabindex="-1"></a>}</span>
<span id="cb137-11"><a href="everyday-iterations.html#cb137-11" tabindex="-1"></a></span>
<span id="cb137-12"><a href="everyday-iterations.html#cb137-12" tabindex="-1"></a><span class="fu">lapply</span>(mtcars_lst, get_pval)</span></code></pre></div>
<pre><code>## [[1]]
## [1] TRUE
## 
## [[2]]
## [1] FALSE
## 
## [[3]]
## [1] TRUE</code></pre>
<p>Using <code>vapply()</code> instead allows you to define the class of what the expected output would be; in this case we obtain a logical vector rather than a list:</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="everyday-iterations.html#cb139-1" tabindex="-1"></a><span class="fu">vapply</span>(mtcars_lst, get_pval, <span class="at">FUN.VALUE =</span> <span class="fu">logical</span>(<span class="dv">1</span>))</span></code></pre></div>
<pre><code>## [1]  TRUE FALSE  TRUE</code></pre>
<p><code>purrr::map()</code> solution to iterating over list is as such:</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb141-1"><a href="everyday-iterations.html#cb141-1" tabindex="-1"></a>mtcars_lst <span class="sc">%&gt;%</span> <span class="fu">map</span>(<span class="sc">~</span> <span class="fu">cor</span>(.x<span class="sc">$</span>mpg, .x<span class="sc">$</span>wt))</span></code></pre></div>
<pre><code>## [[1]]
## [1] -0.7131848
## 
## [[2]]
## [1] -0.6815498
## 
## [[3]]
## [1] -0.650358</code></pre>
<p>If we want the output to be a flat numeric vector instead of a list:</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb143-1"><a href="everyday-iterations.html#cb143-1" tabindex="-1"></a>mtcars_lst <span class="sc">%&gt;%</span> <span class="fu">map_dbl</span>(<span class="sc">~</span> <span class="fu">cor</span>(.x<span class="sc">$</span>mpg, .x<span class="sc">$</span>wt))</span></code></pre></div>
<pre><code>## [1] -0.7131848 -0.6815498 -0.6503580</code></pre>
<p>Similarly, using <code>map_lgl()</code> instead would return a logical vector:</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb145-1"><a href="everyday-iterations.html#cb145-1" tabindex="-1"></a>mtcars_lst <span class="sc">%&gt;%</span> <span class="fu">map_lgl</span>(get_pval)</span></code></pre></div>
<pre><code>## [1]  TRUE FALSE  TRUE</code></pre>
<p>Iterations are also useful when we want to generate visualizations based on the grouped split:</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb147-1"><a href="everyday-iterations.html#cb147-1" tabindex="-1"></a>p <span class="ot">&lt;-</span> mtcars_lst <span class="sc">%&gt;%</span> <span class="fu">map</span>(<span class="sc">~</span> <span class="fu">ggplot</span>(<span class="at">data =</span> .x, <span class="fu">aes</span>(<span class="at">x =</span> mpg, <span class="at">y =</span> wt)) <span class="sc">+</span> </span>
<span id="cb147-2"><a href="everyday-iterations.html#cb147-2" tabindex="-1"></a>                          <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&#39;lm&#39;</span>) <span class="sc">+</span> </span>
<span id="cb147-3"><a href="everyday-iterations.html#cb147-3" tabindex="-1"></a>                          <span class="fu">theme_bw</span>())</span>
<span id="cb147-4"><a href="everyday-iterations.html#cb147-4" tabindex="-1"></a></span>
<span id="cb147-5"><a href="everyday-iterations.html#cb147-5" tabindex="-1"></a>p[[<span class="dv">1</span>]]</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-80-1.png" width="672" /></p>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb148-1"><a href="everyday-iterations.html#cb148-1" tabindex="-1"></a>p[[<span class="dv">3</span>]]</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-80-2.png" width="672" /></p>
<p>Combining the package <code>broom</code> with iterative model fitting is particularly useful:</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb149-1"><a href="everyday-iterations.html#cb149-1" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb149-2"><a href="everyday-iterations.html#cb149-2" tabindex="-1"></a>mtcars_lst <span class="sc">%&gt;%</span></span>
<span id="cb149-3"><a href="everyday-iterations.html#cb149-3" tabindex="-1"></a>  <span class="fu">map</span>(<span class="sc">~</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> gear, <span class="at">data =</span> .x)) <span class="sc">%&gt;%</span></span>
<span id="cb149-4"><a href="everyday-iterations.html#cb149-4" tabindex="-1"></a>  <span class="fu">map</span>(glance) <span class="sc">%&gt;%</span></span>
<span id="cb149-5"><a href="everyday-iterations.html#cb149-5" tabindex="-1"></a>  <span class="fu">bind_rows</span>()</span></code></pre></div>
<pre><code>## # A tibble: 3 × 12
##   r.squared adj.r.squared sigma statistic p.value
##       &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;
## 1 0.115            0.0163  4.47  1.17       0.308
## 2 0.0000902       -0.200   1.59  0.000451   0.984
## 3 0.00246         -0.0807  2.66  0.0297     0.866
## # ℹ 7 more variables: df &lt;dbl&gt;, logLik &lt;dbl&gt;,
## #   AIC &lt;dbl&gt;, BIC &lt;dbl&gt;, deviance &lt;dbl&gt;,
## #   df.residual &lt;int&gt;, nobs &lt;int&gt;</code></pre>
<p>Using <code>lapply()</code> instead:</p>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb151-1"><a href="everyday-iterations.html#cb151-1" tabindex="-1"></a><span class="fu">lapply</span>(mtcars_lst, <span class="cf">function</span>(x) <span class="fu">lm</span>(mpg <span class="sc">~</span> gear, <span class="at">data =</span> x)) <span class="sc">%&gt;%</span></span>
<span id="cb151-2"><a href="everyday-iterations.html#cb151-2" tabindex="-1"></a>  <span class="fu">lapply</span>(glance) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span></code></pre></div>
<pre><code>## # A tibble: 3 × 12
##   r.squared adj.r.squared sigma statistic p.value
##       &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;
## 1 0.115            0.0163  4.47  1.17       0.308
## 2 0.0000902       -0.200   1.59  0.000451   0.984
## 3 0.00246         -0.0807  2.66  0.0297     0.866
## # ℹ 7 more variables: df &lt;dbl&gt;, logLik &lt;dbl&gt;,
## #   AIC &lt;dbl&gt;, BIC &lt;dbl&gt;, deviance &lt;dbl&gt;,
## #   df.residual &lt;int&gt;, nobs &lt;int&gt;</code></pre>
<p>The <code>map()</code> function can also be used to extract elements:</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb153-1"><a href="everyday-iterations.html#cb153-1" tabindex="-1"></a>mtcars_lst <span class="sc">%&gt;%</span> <span class="fu">map</span>(<span class="st">&#39;CAR&#39;</span>)</span></code></pre></div>
<pre><code>## [[1]]
##  [1] &quot;Datsun 710&quot;     &quot;Merc 240D&quot;     
##  [3] &quot;Merc 230&quot;       &quot;Fiat 128&quot;      
##  [5] &quot;Honda Civic&quot;    &quot;Toyota Corolla&quot;
##  [7] &quot;Toyota Corona&quot;  &quot;Fiat X1-9&quot;     
##  [9] &quot;Porsche 914-2&quot;  &quot;Lotus Europa&quot;  
## [11] &quot;Volvo 142E&quot;    
## 
## [[2]]
## [1] &quot;Mazda RX4&quot;      &quot;Mazda RX4 Wag&quot; 
## [3] &quot;Hornet 4 Drive&quot; &quot;Valiant&quot;       
## [5] &quot;Merc 280&quot;       &quot;Merc 280C&quot;     
## [7] &quot;Ferrari Dino&quot;  
## 
## [[3]]
##  [1] &quot;Hornet Sportabout&quot;   &quot;Duster 360&quot;         
##  [3] &quot;Merc 450SE&quot;          &quot;Merc 450SL&quot;         
##  [5] &quot;Merc 450SLC&quot;         &quot;Cadillac Fleetwood&quot; 
##  [7] &quot;Lincoln Continental&quot; &quot;Chrysler Imperial&quot;  
##  [9] &quot;Dodge Challenger&quot;    &quot;AMC Javelin&quot;        
## [11] &quot;Camaro Z28&quot;          &quot;Pontiac Firebird&quot;   
## [13] &quot;Ford Pantera L&quot;      &quot;Maserati Bora&quot;</code></pre>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb155-1"><a href="everyday-iterations.html#cb155-1" tabindex="-1"></a>mtcars_lst <span class="sc">%&gt;%</span></span>
<span id="cb155-2"><a href="everyday-iterations.html#cb155-2" tabindex="-1"></a>  <span class="fu">map</span>(<span class="sc">~</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> gear, <span class="at">data =</span> .x)) <span class="sc">%&gt;%</span></span>
<span id="cb155-3"><a href="everyday-iterations.html#cb155-3" tabindex="-1"></a>  <span class="fu">map</span>(coef) <span class="sc">%&gt;%</span></span>
<span id="cb155-4"><a href="everyday-iterations.html#cb155-4" tabindex="-1"></a>  <span class="fu">map_dbl</span>(<span class="dv">2</span>)</span></code></pre></div>
<pre><code>## [1]  2.83125 -0.02000  0.17500</code></pre>
</div>
<div id="iterating-over-vectors" class="section level2 hasAnchor" number="3.3">
<h2><span class="header-section-number">3.3</span> Iterating over vectors<a href="everyday-iterations.html#iterating-over-vectors" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Let’s say we have a vector with missing values:</p>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb157-1"><a href="everyday-iterations.html#cb157-1" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">2</span>, <span class="cn">NA</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">2</span>, <span class="cn">NA</span>, <span class="dv">2</span>, <span class="cn">NA</span>)</span>
<span id="cb157-2"><a href="everyday-iterations.html#cb157-2" tabindex="-1"></a>x</span></code></pre></div>
<pre><code>##  [1]  3  2 NA  2  1  4  2 NA  2 NA</code></pre>
<p>Imputing the missing values is easy with iteration over the length of the vector:</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="everyday-iterations.html#cb159-1" tabindex="-1"></a>x <span class="sc">%&gt;%</span> <span class="fu">map_dbl</span>(<span class="sc">~</span> <span class="fu">replace</span>(., <span class="fu">is.na</span>(.x), <span class="dv">0</span>))</span></code></pre></div>
<pre><code>##  [1] 3 2 0 2 1 4 2 0 2 0</code></pre>
<p>Or if we want to replace the missing values with the mean:</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="everyday-iterations.html#cb161-1" tabindex="-1"></a>x <span class="sc">%&gt;%</span> <span class="fu">map_dbl</span>(<span class="sc">~</span> <span class="fu">replace</span>(., <span class="fu">is.na</span>(.x), <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)))</span></code></pre></div>
<pre><code>##  [1] 3.000000 2.000000 2.285714 2.000000 1.000000
##  [6] 4.000000 2.000000 2.285714 2.000000 2.285714</code></pre>
<p>This can of course be done with a for loop instead:</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="everyday-iterations.html#cb163-1" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(x)){</span>
<span id="cb163-2"><a href="everyday-iterations.html#cb163-2" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(x[i]) <span class="sc">==</span> <span class="cn">TRUE</span>){</span>
<span id="cb163-3"><a href="everyday-iterations.html#cb163-3" tabindex="-1"></a>    x[i] <span class="ot">&lt;-</span> <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb163-4"><a href="everyday-iterations.html#cb163-4" tabindex="-1"></a>  }</span>
<span id="cb163-5"><a href="everyday-iterations.html#cb163-5" tabindex="-1"></a>}</span>
<span id="cb163-6"><a href="everyday-iterations.html#cb163-6" tabindex="-1"></a></span>
<span id="cb163-7"><a href="everyday-iterations.html#cb163-7" tabindex="-1"></a>x</span></code></pre></div>
<pre><code>##  [1] 3.000000 2.000000 2.285714 2.000000 1.000000
##  [6] 4.000000 2.000000 2.285714 2.000000 2.285714</code></pre>
<p>Note that <code>seq_along(x)</code> prints the indices along the length of the vector, as if to write <code>1:length(x)</code>.</p>
<p>Iterating over a vector of characters requires <code>map_chr()</code> to get the character vector back, but the syntax is the same:</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb165-1"><a href="everyday-iterations.html#cb165-1" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Brian&#39;</span>, <span class="st">&#39;Connor&#39;</span>, <span class="st">&#39;Harry&#39;</span>, <span class="st">&#39;Sonny&#39;</span>)</span>
<span id="cb165-2"><a href="everyday-iterations.html#cb165-2" tabindex="-1"></a><span class="fu">map_chr</span>(z, <span class="sc">~</span> <span class="fu">paste0</span>(.x, <span class="st">&#39;_NAME&#39;</span>))</span></code></pre></div>
<pre><code>## [1] &quot;Brian_NAME&quot;  &quot;Connor_NAME&quot; &quot;Harry_NAME&quot; 
## [4] &quot;Sonny_NAME&quot;</code></pre>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb167-1"><a href="everyday-iterations.html#cb167-1" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">character</span>(<span class="fu">length</span>(z))</span>
<span id="cb167-2"><a href="everyday-iterations.html#cb167-2" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(z)){</span>
<span id="cb167-3"><a href="everyday-iterations.html#cb167-3" tabindex="-1"></a>  out[i] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(z[i], <span class="st">&#39;_NAME&#39;</span>)</span>
<span id="cb167-4"><a href="everyday-iterations.html#cb167-4" tabindex="-1"></a>}</span>
<span id="cb167-5"><a href="everyday-iterations.html#cb167-5" tabindex="-1"></a>out</span></code></pre></div>
<pre><code>## [1] &quot;Brian_NAME&quot;  &quot;Connor_NAME&quot; &quot;Harry_NAME&quot; 
## [4] &quot;Sonny_NAME&quot;</code></pre>
<p>In particular cases where the output is printed out, as in the case of <code>print()</code> and <code>cat()</code>, we may end up echoing both the return values and the output list when using <code>map()</code>. To that end, <code>walk()</code> is used to avoid showing the result twice:</p>
<div class="sourceCode" id="cb169"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb169-1"><a href="everyday-iterations.html#cb169-1" tabindex="-1"></a><span class="fu">walk</span>(z, <span class="sc">~</span> <span class="fu">print</span>(<span class="fu">paste0</span>(.x, <span class="st">&#39;_NAME&#39;</span>)))</span></code></pre></div>
<pre><code>## [1] &quot;Brian_NAME&quot;
## [1] &quot;Connor_NAME&quot;
## [1] &quot;Harry_NAME&quot;
## [1] &quot;Sonny_NAME&quot;</code></pre>
</div>
<div id="iterating-with-two-inputs" class="section level2 hasAnchor" number="3.4">
<h2><span class="header-section-number">3.4</span> Iterating with two inputs<a href="everyday-iterations.html#iterating-with-two-inputs" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In contrast to every solution so far, there’s a case to be made about iterating over multiple inputs. For that purpose, <code>purrr:map2()</code> does the job.</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb171-1"><a href="everyday-iterations.html#cb171-1" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">5</span>)</span>
<span id="cb171-2"><a href="everyday-iterations.html#cb171-2" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">6</span>, <span class="dv">3</span>, <span class="dv">1</span>)</span>
<span id="cb171-3"><a href="everyday-iterations.html#cb171-3" tabindex="-1"></a><span class="fu">map2_dbl</span>(x, y, sum)</span></code></pre></div>
<pre><code>## [1]  4 10  5  6</code></pre>
<div class="sourceCode" id="cb173"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb173-1"><a href="everyday-iterations.html#cb173-1" tabindex="-1"></a><span class="fu">map2_chr</span>(x, y, <span class="sc">~</span> <span class="fu">str_glue</span>(<span class="st">&#39;The sum of {.x} and {.y} is {sum(.x, .y)}&#39;</span>))</span></code></pre></div>
<pre><code>## [1] &quot;The sum of 2 and 2 is 4&quot; 
## [2] &quot;The sum of 4 and 6 is 10&quot;
## [3] &quot;The sum of 2 and 3 is 5&quot; 
## [4] &quot;The sum of 5 and 1 is 6&quot;</code></pre>
<p>Note that the iteration occurs at the <em>i</em>th position of each vector.</p>
<p>The intuition behind <code>map2()</code> is straightforward and is illustrated by the equivalent for loop:</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb175-1"><a href="everyday-iterations.html#cb175-1" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(x))</span>
<span id="cb175-2"><a href="everyday-iterations.html#cb175-2" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(x)){</span>
<span id="cb175-3"><a href="everyday-iterations.html#cb175-3" tabindex="-1"></a>  result[i] <span class="ot">&lt;-</span> <span class="fu">sum</span>(x[i], y[i])</span>
<span id="cb175-4"><a href="everyday-iterations.html#cb175-4" tabindex="-1"></a>}</span>
<span id="cb175-5"><a href="everyday-iterations.html#cb175-5" tabindex="-1"></a>result</span></code></pre></div>
<pre><code>## [1]  4 10  5  6</code></pre>
<p>One quirk with <code>map2()</code> is that it recycles the input:</p>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb177-1"><a href="everyday-iterations.html#cb177-1" tabindex="-1"></a><span class="fu">map2_chr</span>(<span class="st">&#39;My name is &#39;</span>, <span class="fu">c</span>(<span class="st">&#39;Brian&#39;</span>, <span class="st">&#39;Connor&#39;</span>), str_c)</span></code></pre></div>
<pre><code>## [1] &quot;My name is Brian&quot;  &quot;My name is Connor&quot;</code></pre>
<p>Suppose a dataset like this one:</p>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb179-1"><a href="everyday-iterations.html#cb179-1" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">A =</span> x, <span class="at">B =</span> y)</span>
<span id="cb179-2"><a href="everyday-iterations.html#cb179-2" tabindex="-1"></a>z</span></code></pre></div>
<pre><code>## # A tibble: 4 × 2
##       A     B
##   &lt;dbl&gt; &lt;dbl&gt;
## 1     2     2
## 2     4     6
## 3     2     3
## 4     5     1</code></pre>
<p>There may be cases where we want to create a new column using <code>mutate()</code> which results from a transformation of the <code>A</code> and <code>B</code> columns at each row.</p>
<p>First, see why the following does not work in creating a column <code>C</code> which takes the higher value between <code>A</code> and <code>B</code> at each row:</p>
<div class="sourceCode" id="cb181"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb181-1"><a href="everyday-iterations.html#cb181-1" tabindex="-1"></a>z <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">C =</span> <span class="fu">max</span>(A, B))</span></code></pre></div>
<pre><code>## # A tibble: 4 × 3
##       A     B     C
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1     2     2     6
## 2     4     6     6
## 3     2     3     6
## 4     5     1     6</code></pre>
<p>Using <code>map2()</code>, however, this does work:</p>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb183-1"><a href="everyday-iterations.html#cb183-1" tabindex="-1"></a>z <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">C =</span> <span class="fu">map2_dbl</span>(A, B, max))</span></code></pre></div>
<pre><code>## # A tibble: 4 × 3
##       A     B     C
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1     2     2     2
## 2     4     6     6
## 3     2     3     3
## 4     5     1     5</code></pre>
<p>Other families of <code>map2()</code> works normally in this context, for example, if we want to check whether the sum of <code>A</code> and <code>B</code> at each row is an even number:</p>
<div class="sourceCode" id="cb185"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb185-1"><a href="everyday-iterations.html#cb185-1" tabindex="-1"></a>z <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">C =</span> <span class="fu">map2_lgl</span>(A, B, <span class="sc">~</span> (.x <span class="sc">+</span> .y) <span class="sc">%%</span> <span class="dv">2</span> <span class="sc">==</span> <span class="dv">0</span>))</span></code></pre></div>
<pre><code>## # A tibble: 4 × 3
##       A     B C    
##   &lt;dbl&gt; &lt;dbl&gt; &lt;lgl&gt;
## 1     2     2 TRUE 
## 2     4     6 TRUE 
## 3     2     3 FALSE
## 4     5     1 TRUE</code></pre>
<p>When there are more than 2 inputs, we can use <code>pmap()</code> instead; this function takes a list of the inputs instead:</p>
<div class="sourceCode" id="cb187"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb187-1"><a href="everyday-iterations.html#cb187-1" tabindex="-1"></a>w <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">1</span>)</span>
<span id="cb187-2"><a href="everyday-iterations.html#cb187-2" tabindex="-1"></a><span class="fu">pmap_dbl</span>(<span class="fu">list</span>(x, y, w), sum)</span></code></pre></div>
<pre><code>## [1]  8 12  8  7</code></pre>
<div class="sourceCode" id="cb189"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb189-1"><a href="everyday-iterations.html#cb189-1" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">A =</span> x, <span class="at">B =</span> y, <span class="at">C =</span> w)</span>
<span id="cb189-2"><a href="everyday-iterations.html#cb189-2" tabindex="-1"></a>z</span></code></pre></div>
<pre><code>## # A tibble: 4 × 3
##       A     B     C
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1     2     2     4
## 2     4     6     2
## 3     2     3     3
## 4     5     1     1</code></pre>
<div class="sourceCode" id="cb191"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb191-1"><a href="everyday-iterations.html#cb191-1" tabindex="-1"></a>z <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">v =</span> <span class="fu">pmap_lgl</span>(<span class="fu">list</span>(A, B, C), <span class="sc">~</span> <span class="fu">sum</span>(.) <span class="sc">%%</span> <span class="dv">2</span> <span class="sc">==</span> <span class="dv">0</span>))</span></code></pre></div>
<pre><code>## # A tibble: 4 × 4
##       A     B     C v    
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;lgl&gt;
## 1     2     2     4 TRUE 
## 2     4     6     2 TRUE 
## 3     2     3     3 TRUE 
## 4     5     1     1 FALSE</code></pre>
<p>Using the notation for anonymous functions instead:</p>
<div class="sourceCode" id="cb193"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb193-1"><a href="everyday-iterations.html#cb193-1" tabindex="-1"></a>z <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">v =</span> <span class="fu">pmap_lgl</span>(<span class="fu">list</span>(A, B, C), <span class="sc">~</span> <span class="fu">sum</span>(..<span class="dv">1</span> <span class="sc">+</span> ..<span class="dv">2</span> <span class="sc">+</span> ..<span class="dv">3</span>) <span class="sc">%%</span> <span class="dv">2</span> <span class="sc">==</span> <span class="dv">0</span>))</span></code></pre></div>
<pre><code>## # A tibble: 4 × 4
##       A     B     C v    
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;lgl&gt;
## 1     2     2     4 TRUE 
## 2     4     6     2 TRUE 
## 3     2     3     3 TRUE 
## 4     5     1     1 FALSE</code></pre>
</div>
<div id="iterating-over-indices-and-names" class="section level2 hasAnchor" number="3.5">
<h2><span class="header-section-number">3.5</span> Iterating over indices and names<a href="everyday-iterations.html#iterating-over-indices-and-names" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>A related function is <code>imap()</code> and its variants, which is analogous to looping over numeric indices, such as in the case of <code>for (i in seq_along(x))</code>. That is, it applies a function over an input and its corresponding index. For example:</p>
<div class="sourceCode" id="cb195"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb195-1"><a href="everyday-iterations.html#cb195-1" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">5</span>)</span>
<span id="cb195-2"><a href="everyday-iterations.html#cb195-2" tabindex="-1"></a><span class="fu">imap_chr</span>(x, <span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">&#39;The index &#39;</span>, .y, <span class="st">&#39; number in x is &#39;</span>, .x))</span></code></pre></div>
<pre><code>## [1] &quot;The index 1 number in x is 2&quot;
## [2] &quot;The index 2 number in x is 4&quot;
## [3] &quot;The index 3 number in x is 2&quot;
## [4] &quot;The index 4 number in x is 5&quot;</code></pre>
<p>Without using <code>purrr</code>, this is equivalent to the for loop:</p>
<div class="sourceCode" id="cb197"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb197-1"><a href="everyday-iterations.html#cb197-1" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">character</span>(<span class="fu">length</span>(x))</span>
<span id="cb197-2"><a href="everyday-iterations.html#cb197-2" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(x)){</span>
<span id="cb197-3"><a href="everyday-iterations.html#cb197-3" tabindex="-1"></a>  out[i] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&#39;The index &#39;</span>, i, <span class="st">&#39; number in x is &#39;</span>, x[i])</span>
<span id="cb197-4"><a href="everyday-iterations.html#cb197-4" tabindex="-1"></a>}</span>
<span id="cb197-5"><a href="everyday-iterations.html#cb197-5" tabindex="-1"></a>out</span></code></pre></div>
<pre><code>## [1] &quot;The index 1 number in x is 2&quot;
## [2] &quot;The index 2 number in x is 4&quot;
## [3] &quot;The index 3 number in x is 2&quot;
## [4] &quot;The index 4 number in x is 5&quot;</code></pre>
<p><code>imap()</code> also works with names instead of indices, if required:</p>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb199-1"><a href="everyday-iterations.html#cb199-1" tabindex="-1"></a><span class="fu">names</span>(x) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;A&#39;</span>, <span class="st">&#39;B&#39;</span>, <span class="st">&#39;C&#39;</span>, <span class="st">&#39;D&#39;</span>)</span>
<span id="cb199-2"><a href="everyday-iterations.html#cb199-2" tabindex="-1"></a><span class="fu">imap_lgl</span>(x, <span class="sc">~</span> <span class="cf">if</span>(.y <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;A&#39;</span>, <span class="st">&#39;C&#39;</span>)) <span class="cn">TRUE</span> <span class="cf">else</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<pre><code>##     A     B     C     D 
##  TRUE FALSE  TRUE FALSE</code></pre>
<p>The equivalent expression in the form of a for loop is as follows:</p>
<div class="sourceCode" id="cb201"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb201-1"><a href="everyday-iterations.html#cb201-1" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">logical</span>()</span>
<span id="cb201-2"><a href="everyday-iterations.html#cb201-2" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">names</span>(x)){</span>
<span id="cb201-3"><a href="everyday-iterations.html#cb201-3" tabindex="-1"></a>  <span class="cf">if</span>(i <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;A&#39;</span>, <span class="st">&#39;C&#39;</span>)){</span>
<span id="cb201-4"><a href="everyday-iterations.html#cb201-4" tabindex="-1"></a>    out[i] <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb201-5"><a href="everyday-iterations.html#cb201-5" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb201-6"><a href="everyday-iterations.html#cb201-6" tabindex="-1"></a>    out[i] <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb201-7"><a href="everyday-iterations.html#cb201-7" tabindex="-1"></a>  }</span>
<span id="cb201-8"><a href="everyday-iterations.html#cb201-8" tabindex="-1"></a>}</span>
<span id="cb201-9"><a href="everyday-iterations.html#cb201-9" tabindex="-1"></a>out</span></code></pre></div>
<pre><code>##     A     B     C     D 
##  TRUE FALSE  TRUE FALSE</code></pre>
<p>Therefore, we see clearly that the two uses of <code>imap()</code> - iterating over indices and over names - is equivalent to <code>for (i in seq_along(x))</code> and <code>for (i in names(x))</code>, respectively.</p>
</div>
<div id="handling-errors-within-purrr" class="section level2 hasAnchor" number="3.6">
<h2><span class="header-section-number">3.6</span> Handling errors within <code>purrr</code><a href="everyday-iterations.html#handling-errors-within-purrr" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Let’s return to the <code>mtcars</code> dataset, specifically after we split the tibble into a list based on <code>group_split(cyl)</code>.</p>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb203-1"><a href="everyday-iterations.html#cb203-1" tabindex="-1"></a>mtcars_lst <span class="ot">&lt;-</span> mtcars <span class="sc">%&gt;%</span> <span class="fu">group_split</span>(cyl)</span></code></pre></div>
<p>For one of the elements of the list, I’m filling the <code>gear</code> column with missing values:</p>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb204-1"><a href="everyday-iterations.html#cb204-1" tabindex="-1"></a>mtcars_lst[[<span class="dv">2</span>]] <span class="ot">&lt;-</span> mtcars_lst[[<span class="dv">2</span>]] <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">gear =</span> <span class="cn">NA</span>)</span>
<span id="cb204-2"><a href="everyday-iterations.html#cb204-2" tabindex="-1"></a>mtcars_lst[[<span class="dv">2</span>]]</span></code></pre></div>
<pre><code>## # A tibble: 7 × 12
##   CAR       mpg   cyl  disp    hp  drat    wt  qsec
##   &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 Mazda …  21       6  160    110  3.9   2.62  16.5
## 2 Mazda …  21       6  160    110  3.9   2.88  17.0
## 3 Hornet…  21.4     6  258    110  3.08  3.22  19.4
## 4 Valiant  18.1     6  225    105  2.76  3.46  20.2
## 5 Merc 2…  19.2     6  168.   123  3.92  3.44  18.3
## 6 Merc 2…  17.8     6  168.   123  3.92  3.44  18.9
## 7 Ferrar…  19.7     6  145    175  3.62  2.77  15.5
## # ℹ 4 more variables: vs &lt;dbl&gt;, am &lt;dbl&gt;,
## #   gear &lt;dbl&gt;, carb &lt;dbl&gt;</code></pre>
<p>Now, if I were to try and fit a linear model using <code>lm(mpg ~ wt)</code> iteratively over the <code>mtcars_lst</code>, it will fail at the second element as the <code>wt</code> values are all missing.</p>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb206-1"><a href="everyday-iterations.html#cb206-1" tabindex="-1"></a>mtcars_lst <span class="sc">%&gt;%</span></span>
<span id="cb206-2"><a href="everyday-iterations.html#cb206-2" tabindex="-1"></a>  <span class="fu">map</span>(<span class="sc">~</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> gear, <span class="at">data =</span> .x)) <span class="sc">%&gt;%</span></span>
<span id="cb206-3"><a href="everyday-iterations.html#cb206-3" tabindex="-1"></a>  <span class="fu">map</span>(coef) <span class="sc">%&gt;%</span></span>
<span id="cb206-4"><a href="everyday-iterations.html#cb206-4" tabindex="-1"></a>  <span class="fu">map_dbl</span>(<span class="dv">2</span>) <span class="co"># returns an error</span></span></code></pre></div>
<p>This is inconvenient in many cases as ideally we’d want to skip over the iteration at which the function fails and get the rest of the results. Thankfully this can be done using <code>possibly()</code>; note the second element in the output where the <code>lm()</code> function would’ve failed:</p>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb207-1"><a href="everyday-iterations.html#cb207-1" tabindex="-1"></a><span class="fu">map</span>(mtcars_lst, <span class="fu">possibly</span>(<span class="sc">~</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> gear, <span class="at">data =</span> .x), <span class="at">otherwise =</span> <span class="cn">NA</span>))</span></code></pre></div>
<pre><code>## [[1]]
## 
## Call:
## lm(formula = mpg ~ gear, data = .x)
## 
## Coefficients:
## (Intercept)         gear  
##      15.081        2.831  
## 
## 
## [[2]]
## [1] NA
## 
## [[3]]
## 
## Call:
## lm(formula = mpg ~ gear, data = .x)
## 
## Coefficients:
## (Intercept)         gear  
##      14.525        0.175</code></pre>
<p>The second argument within <code>otherwise =</code> argument within <code>possibly()</code>, where we wrapped the iterative function, provides an alternative solution in case the function fails. As we can see above, the second element of the output corresponds to <code>NA</code> and the iteration continued after.</p>
<p>Using <code>purrr::keep()</code> I can select for the elements that did not fail:</p>
<div class="sourceCode" id="cb209"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb209-1"><a href="everyday-iterations.html#cb209-1" tabindex="-1"></a><span class="fu">map</span>(mtcars_lst, <span class="fu">possibly</span>(<span class="sc">~</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> gear, <span class="at">data =</span> .x), <span class="at">otherwise =</span> <span class="cn">NA</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb209-2"><a href="everyday-iterations.html#cb209-2" tabindex="-1"></a>  <span class="fu">keep</span>(<span class="sc">~</span> <span class="sc">!</span><span class="fu">is.na</span>(.x) <span class="sc">%&gt;%</span> <span class="fu">all</span>())</span></code></pre></div>
<pre><code>## [[1]]
## 
## Call:
## lm(formula = mpg ~ gear, data = .x)
## 
## Coefficients:
## (Intercept)         gear  
##      15.081        2.831  
## 
## 
## [[2]]
## 
## Call:
## lm(formula = mpg ~ gear, data = .x)
## 
## Coefficients:
## (Intercept)         gear  
##      14.525        0.175</code></pre>
<p>Of course this is the same as running the first <code>map()</code> function wrapped around <code>possibly()</code> and then running <code>result[-which(is.na(result)]</code>.</p>
<p>Sometimes it’s not useful to keep the failed element in the first place, so setting <code>otherwise = NULL</code> within <code>possibly()</code> works too. Afterwards, removing the empty element (i.e., <code>NULL</code>) is done using <code>purrr::compact()</code>.</p>
<div class="sourceCode" id="cb211"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb211-1"><a href="everyday-iterations.html#cb211-1" tabindex="-1"></a><span class="fu">map</span>(mtcars_lst, <span class="fu">possibly</span>(<span class="sc">~</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> gear, <span class="at">data =</span> .x), <span class="at">otherwise =</span> <span class="cn">NULL</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb211-2"><a href="everyday-iterations.html#cb211-2" tabindex="-1"></a>  <span class="fu">compact</span>()</span></code></pre></div>
<pre><code>## [[1]]
## 
## Call:
## lm(formula = mpg ~ gear, data = .x)
## 
## Coefficients:
## (Intercept)         gear  
##      15.081        2.831  
## 
## 
## [[2]]
## 
## Call:
## lm(formula = mpg ~ gear, data = .x)
## 
## Coefficients:
## (Intercept)         gear  
##      14.525        0.175</code></pre>
<p>Instead of discarding the iteration where the function failed, we could also catch the error by using <code>safely()</code> instead. This returns a nested list as such:</p>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="everyday-iterations.html#cb213-1" tabindex="-1"></a><span class="fu">map</span>(mtcars_lst, <span class="fu">safely</span>(<span class="sc">~</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> gear, <span class="at">data =</span> .x)))</span></code></pre></div>
<pre><code>## [[1]]
## [[1]]$result
## 
## Call:
## lm(formula = mpg ~ gear, data = .x)
## 
## Coefficients:
## (Intercept)         gear  
##      15.081        2.831  
## 
## 
## [[1]]$error
## NULL
## 
## 
## [[2]]
## [[2]]$result
## NULL
## 
## [[2]]$error
## &lt;simpleError in lm.fit(x, y, offset = offset, singular.ok = singular.ok, ...): 0 (non-NA) cases&gt;
## 
## 
## [[3]]
## [[3]]$result
## 
## Call:
## lm(formula = mpg ~ gear, data = .x)
## 
## Coefficients:
## (Intercept)         gear  
##      14.525        0.175  
## 
## 
## [[3]]$error
## NULL</code></pre>
<p>We could also just pull the <code>error</code> terms and throw away the empty <code>NULL</code> elements:</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="everyday-iterations.html#cb215-1" tabindex="-1"></a><span class="fu">map</span>(mtcars_lst, <span class="fu">safely</span>(<span class="sc">~</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> gear, <span class="at">data =</span> .x))) <span class="sc">%&gt;%</span> <span class="fu">map</span>(<span class="st">&#39;error&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb215-2"><a href="everyday-iterations.html#cb215-2" tabindex="-1"></a>  <span class="fu">compact</span>()</span></code></pre></div>
<pre><code>## [[1]]
## &lt;simpleError in lm.fit(x, y, offset = offset, singular.ok = singular.ok, ...): 0 (non-NA) cases&gt;</code></pre>
<p>In a traditional for loop without <code>purrr</code>, a solution could be to use <code>tryCatch()</code> with <code>next</code>. Below returns the iteration with the error as <code>NULL</code> as was the case with <code>possibly(..., otherwise = NULL)</code>.</p>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb217-1"><a href="everyday-iterations.html#cb217-1" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb217-2"><a href="everyday-iterations.html#cb217-2" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(mtcars_lst)){</span>
<span id="cb217-3"><a href="everyday-iterations.html#cb217-3" tabindex="-1"></a>  err <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb217-4"><a href="everyday-iterations.html#cb217-4" tabindex="-1"></a>    mod[[i]] <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> gear, <span class="at">data =</span> mtcars_lst[[i]]), </span>
<span id="cb217-5"><a href="everyday-iterations.html#cb217-5" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) e</span>
<span id="cb217-6"><a href="everyday-iterations.html#cb217-6" tabindex="-1"></a>  )</span>
<span id="cb217-7"><a href="everyday-iterations.html#cb217-7" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">inherits</span>(err, <span class="st">&#39;error&#39;</span>)) <span class="cf">next</span></span>
<span id="cb217-8"><a href="everyday-iterations.html#cb217-8" tabindex="-1"></a>  mod[[i]] <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> gear, <span class="at">data =</span> mtcars_lst[[i]])</span>
<span id="cb217-9"><a href="everyday-iterations.html#cb217-9" tabindex="-1"></a>}</span>
<span id="cb217-10"><a href="everyday-iterations.html#cb217-10" tabindex="-1"></a>mod</span></code></pre></div>
<pre><code>## [[1]]
## 
## Call:
## lm(formula = mpg ~ gear, data = mtcars_lst[[i]])
## 
## Coefficients:
## (Intercept)         gear  
##      15.081        2.831  
## 
## 
## [[2]]
## NULL
## 
## [[3]]
## 
## Call:
## lm(formula = mpg ~ gear, data = mtcars_lst[[i]])
## 
## Coefficients:
## (Intercept)         gear  
##      14.525        0.175</code></pre>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="everyday-data-wrangling.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="interlude-i-a-brief-glimpse-into-data.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/02-Iterations.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
